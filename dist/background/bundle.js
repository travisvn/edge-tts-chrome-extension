(()=>{"use strict";let e=null,t=!1;var n=function(e,t,n,o){return new(n||(n=Promise))((function(r,c){function i(e){try{d(o.next(e))}catch(e){c(e)}}function s(e){try{d(o.throw(e))}catch(e){c(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((o=o.apply(e,t||[])).next())}))};let o=!1,r=[];function c(c){return n(this,void 0,void 0,(function*(){if(o)r.push(c);else{o=!0;try{for(yield function(n){return o=this,r=void 0,i=function*(){const o=chrome.runtime.getURL(n);if((yield chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[o]})).length>0)return t?void 0:(yield new Promise((e=>setTimeout(e,100))),void(t=!0));if(e)yield e;else{console.log("[Setup] Creating offscreen document:",n),e=chrome.offscreen.createDocument({url:n,reasons:[chrome.offscreen.Reason.AUDIO_PLAYBACK,chrome.offscreen.Reason.LOCAL_STORAGE],justification:"play text to speech audio file"});try{yield e,yield new Promise((e=>setTimeout(e,300))),t=!0}catch(e){console.error("[Setup] Error creating offscreen document:",e)}finally{e=null}}},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{d(i.next(e))}catch(e){t(e)}}function s(e){try{d(i.throw(e))}catch(e){t(e)}}function d(t){var o;t.done?e(t.value):(o=t.value,o instanceof c?o:new c((function(e){e(o)}))).then(n,s)}d((i=i.apply(o,r||[])).next())}));var o,r,c,i}("offScreen/off-screen.html"),i(c);r.length>0;)i(r.shift())}finally{o=!1}}}))}function i(e){console.log("[Background] Processing message:",e),chrome.runtime.sendMessage(e)}chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"readAloud",title:"Read Aloud with Edge TTS",contexts:["selection"]}),chrome.contextMenus.create({id:"readPage",title:"Read Page Aloud with Edge TTS",contexts:["page"]})})),chrome.contextMenus.onClicked.addListener(((e,t)=>n(void 0,void 0,void 0,(function*(){if(!(null==t?void 0:t.id))return void console.error("[Background] Tab not found.");const o=yield chrome.storage.sync.get({voiceName:"en-US-ChristopherNeural",customVoice:"",speed:1.2});"readAloud"===e.menuItemId&&e.selectionText?c({type:"readText",target:"offscreen",data:e.selectionText,settings:o}):"readPage"===e.menuItemId&&function(){n(this,void 0,void 0,(function*(){chrome.tabs.query({active:!0,currentWindow:!0},(e=>n(this,void 0,void 0,(function*(){if(!e||0===e.length||!e[0].id)return;const t=e[0].id,n=yield chrome.storage.sync.get({voiceName:"en-US-ChristopherNeural",customVoice:"",speed:1.2});chrome.scripting.executeScript({target:{tabId:t},func:()=>document.body.innerText}).then((e=>{if(e&&e.length>0&&e[0].result){const t=e[0].result;console.log("[Background] Sending page content to offscreen."),c({type:"readText",target:"offscreen",data:t,settings:n})}}))}))))}))}()})))),chrome.commands.onCommand.addListener((e=>n(void 0,void 0,void 0,(function*(){if("read-selected-text"===e){const e=yield chrome.storage.sync.get({voiceName:"en-US-ChristopherNeural",customVoice:"",speed:1.2});chrome.tabs.query({active:!0,currentWindow:!0},(t=>{if(!t||0===t.length||!t[0].id)return;const n=t[0].id;chrome.scripting.executeScript({target:{tabId:n},func:()=>window.getSelection().toString()}).then((t=>{if(t&&t.length>0&&t[0].result){const n=t[0].result;console.log("[Background] Sending selected text to offscreen."),c({type:"readText",target:"offscreen",data:n,settings:e})}else console.warn("[Background] No text selected.")})).catch((e=>console.error("[Background] Error executing script:",e)))}))}})))),chrome.runtime.onMessage.addListener(((e,t,o)=>n(void 0,void 0,void 0,(function*(){console.log("[Background] Received message:",e),"offscreen"===e.target&&e.type?c(e):e.action&&e.action.startsWith("controlPanel:")&&chrome.tabs.query({active:!0,currentWindow:!0},(t=>{if(!t||0===t.length||!t[0].id)return void console.error("[Background] No active tab found.");const n=t[0].id;chrome.tabs.sendMessage(n,e)}))}))))})();