(()=>{"use strict";let e=null;function t(t){return n=this,o=void 0,c=function*(){const n=chrome.runtime.getURL(t);(yield chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[n]})).length>0||(e?yield e:(e=chrome.offscreen.createDocument({url:t,reasons:[chrome.offscreen.Reason.AUDIO_PLAYBACK,chrome.offscreen.Reason.LOCAL_STORAGE],justification:"play text to speech audio file"}),yield e,e=null))},new((r=void 0)||(r=Promise))((function(e,t){function i(e){try{a(c.next(e))}catch(e){t(e)}}function s(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,s)}a((c=c.apply(n,o||[])).next())}));var n,o,r,c}var n=function(e,t,n,o){return new(n||(n=Promise))((function(r,c){function i(e){try{a(o.next(e))}catch(e){c(e)}}function s(e){try{a(o.throw(e))}catch(e){c(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}a((o=o.apply(e,t||[])).next())}))};function o(){return n(this,void 0,void 0,(function*(){yield t("offScreen/off-screen.html"),chrome.tabs.query({active:!0,currentWindow:!0},(e=>n(this,void 0,void 0,(function*(){if(!e||0===e.length||!e[0].id)return;const t=e[0].id,n=yield chrome.storage.sync.get({voiceName:"en-US-ChristopherNeural",customVoice:"",speed:1.2});chrome.scripting.executeScript({target:{tabId:t},func:()=>document.body.innerText}).then((e=>{if(e&&e.length>0&&e[0].result){const t=e[0].result;console.log("[Background] Sending page content to offscreen."),chrome.runtime.sendMessage({type:"readText",target:"offscreen",data:t,settings:n})}}))}))))}))}chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"readAloud",title:"Read Aloud with Edge TTS",contexts:["selection"]}),chrome.contextMenus.create({id:"readPage",title:"Read Page Aloud with Edge TTS",contexts:["page"]})})),chrome.contextMenus.onClicked.addListener(((e,r)=>n(void 0,void 0,void 0,(function*(){if(!(null==r?void 0:r.id))return void console.error("[Background] Tab not found.");const n=yield chrome.storage.sync.get({voiceName:"en-US-ChristopherNeural",customVoice:"",speed:1.2});"readAloud"===e.menuItemId&&e.selectionText?(yield t("offScreen/off-screen.html"),chrome.runtime.sendMessage({type:"readText",target:"offscreen",data:e.selectionText,settings:n})):"readPage"===e.menuItemId&&o()})))),chrome.commands.onCommand.addListener((e=>n(void 0,void 0,void 0,(function*(){if("read-selected-text"===e){yield t("offScreen/off-screen.html");const e=yield chrome.storage.sync.get({voiceName:"en-US-ChristopherNeural",customVoice:"",speed:1.2});chrome.tabs.query({active:!0,currentWindow:!0},(t=>{if(!t||0===t.length||!t[0].id)return;const n=t[0].id;chrome.scripting.executeScript({target:{tabId:n},func:()=>window.getSelection().toString()}).then((t=>{if(t&&t.length>0&&t[0].result){const n=t[0].result;console.log("[Background] Sending selected text to offscreen."),chrome.runtime.sendMessage({type:"readText",target:"offscreen",data:n,settings:e})}else console.warn("[Background] No text selected.")})).catch((e=>console.error("[Background] Error executing script:",e)))}))}})))),chrome.runtime.onMessage.addListener(((e,r,c)=>n(void 0,void 0,void 0,(function*(){console.log("[Background] Received message:",e),["readText","togglePause","stopPlayback"].includes(e.type)&&"offscreen"===e.target&&(yield t("offScreen/off-screen.html")),"offscreen:readPage"===e.action?o():"offscreen:togglePause"===e.action?chrome.runtime.sendMessage({type:"togglePause",target:"offscreen",isPaused:e.isPaused}):"offscreen:stopPlayback"===e.action?(console.log("[Background] Stopping playback and removing control panel."),chrome.runtime.sendMessage({type:"stopPlayback",target:"offscreen"})):chrome.tabs.query({active:!0,currentWindow:!0},(t=>{if(!t||0===t.length||!t[0].id)return void console.error("[Background] No active tab found.");const n=t[0].id;chrome.tabs.sendMessage(n,e)}))}))))})();